# 背景
- 小規模飲食店のオーナーは、仕入れ・接客・シフト調整・給与計算を日々一人で回していることが多い。スタッフは数人〜20人程度で、学生アルバイトやパートが中心。
- スタッフは各自で出勤・退勤を打刻しているが、忙しい時間帯に押し忘れや打刻ズレが発生しがち。月末に給与計算をするとき、紙やチャットで確認が必要になる。
- オーナーは「毎日の現場確認」と「月末の締め確認」を短時間で終わらせたいが、汎用的な勤怠システムは機能が多く、逆に操作が面倒。軽く状況を把握し、異常だけ素早く修正したい。

# 課題
1. 打刻忘れ（出勤／退勤の押し忘れ）が多く、給与計算前に毎回紙やチャットで確認が必要になる。
2. 実際の勤務時間と打刻時間がずれていて、どこまで修正すべきか判断が難しい。
3. 月末に「残業し過ぎていないか」を確認したいが、エクセルの集計に時間がかかる。
4. スタッフごとの勤務傾向（いつも遅刻しがち、シフトより早く帰る等）が直感的にわからない。

# 解決方法 / 機能一覧
| 機能No. | 機能名称                         | 機能優先度 (高/中/低) | 実装予定 (あり/なし) | 実装状況 (未着手/実装済み) | 対応する課題 (番号) |
|--------|----------------------------------|------------------------|----------------------|----------------------------|----------------------|
| 1      | 日別勤怠ダッシュボード          | 高                     | あり                 | 実装済み                   | 1, 2, 3              |
| 2      | 打刻異常アラート一覧            | 高                     | あり                 | 実装済み                   | 1, 2, 3              |
| 3      | スタッフ別勤怠サマリー画面       | 中                     | あり                 | 実装済み                   | 3, 4                 |
| 4      | シフト想定時間との乖離ハイライト | 中                     | なし                 | 未着手                     | 2, 4                 |
| 5      | CSVインポート/エクスポート      | 低                     | なし                 | 未着手                     | 1, 3                 |
| 6      | 簡易ログイン/セルフ打刻         | 高                     | あり                 | 実装済み                   | 1, 2                 |
| 7      | パスワードリセット (メール)     | 低                     | なし                 | 未実装　　　　　　　         | -                    |
| 8      | 多要素認証 (2FA)                | 低                     | なし                 | 未実装　　　　　         | -                    |

## 機能No.1 日別勤怠ダッシュボード
- 選択した日付（または範囲）のスタッフごとの打刻状況を一覧表示。出勤・退勤時刻、合計勤務時間、異常の有無をバッジで示す。
- 課題1・2・3を解決：打刻漏れや長時間労働を一目で把握し、修正対象を即座に見つけられる。
- 実装詳細：Next.js (app router) + Mantine の `AppShell`, `DatePickerInput`, `Table`, `Badge` を用いた UI。データは Prisma 経由で取得し、`lib/attendance.ts` で集計。
- 本リポジトリで実装済み（`/admin` ダッシュボード）。

## 実装済み機能
- [x] 管理者ダッシュボード（一覧、異常検知、フィルタリング）
- [x] 従業員打刻画面（出勤/退勤/休憩、ライブ時計）
- [x] 打刻修正（UI: 当日＋直近14日を表示・編集、API: 日付制限なしで追加/更新可）
- [x] 給与概算（時給×時間、残業・深夜割増対応）
  - [x] 深夜勤務（22:00-05:00）の自動判定（日跨ぎ対応済み）
  - [x] 8時間超の残業判定
- [x] 従業員管理
  - [x] 従業員一覧・詳細
  - [x] 時給履歴管理
  - [x] 従業員アカウント作成・パスワードリセット
- [x] 従業員設定
  - [x] パスワード変更
- [x] 認証（セッションベース、ロール管理）

## 計算仕様
- **時間フォーマット**: `HH:mm` (00:00 〜 49:59)。分は `00-59` のみ許容。
- **深夜勤務判定**:
  - 基準: **勤務開始日**の 22:00 〜 翌 05:00 (29:00)。
  - 日跨ぎ: 29:00 (翌05:00) を超える勤務（例: 30:00終了）の場合も、基準日の深夜帯 (22:00-29:00) に含まれる時間は深夜手当の対象となります。
  - サイクル: 勤務開始日を基準とした1サイクル（24時間+α）のみを考慮し、翌々日の深夜帯などは考慮しません。
- **休憩と深夜手当**:
  - 現行仕様では、休憩時間が深夜帯に含まれる場合でも、深夜手当の対象時間から休憩時間を差し引く処理は行っていません（深夜帯の総労働時間ではなく、深夜帯の総時間に基づいて計算される場合があります）。
  - ただし、**深夜手当の対象時間は実労働時間（休憩控除後）を上限とします**。そのため、休憩によって実労働時間が深夜帯の長さを下回る場合は、実質的に深夜手当が減少する場合があります。これは簡易実装による仕様です。

## 機能No.2 打刻異常アラート一覧
- 打刻漏れ（出勤／退勤欠損）や長時間勤務（1日8時間超など）、休憩不足・深夜勤務を検知し、フィルタで「異常のみ」を抽出表示。
- 課題1・2・3を解決：修正すべきレコードだけに集中でき、月末確認時間を短縮。
- 実装詳細：ダッシュボードに「打刻異常」「休憩不足」のクイックフィルタを実装。異常検知ロジックは `detectIssues` 関数で共通化。
- 本リポジトリで実装済み（ダッシュボードのフィルタ、異常バッジ）。
  - **異常バッジ**: 「打刻漏れ」「長時間勤務」「休憩不足」「深夜勤務」を表示。問題がない場合は「問題なし」バッジを表示。

## 機能No.3 スタッフ別勤怠サマリー画面
- スタッフ一覧と、各スタッフの最近の勤務時間・異常件数を表示。スタッフをクリックすると個別の詳細画面へ遷移。
- 課題3・4を解決：残業が多いスタッフや遅刻傾向を素早く特定できる。
- 実装詳細：`/employees` で一覧、`/employees/[id]` で選択した月の打刻詳細を表形式で表示（デフォルトは最新月）。
- 本リポジトリで実装済み（`/employees`, `/employees/[id]`）。
  - **給与概算**: 時給計算に加え、残業（8時間超）と深夜（22:00-05:00）の25%割増を自動計算して表示。

## 機能No.4 シフト想定時間との乖離ハイライト (未実装)
- シフト予定時間と実績の差分を表示し、早退・遅刻・残業を自動ハイライト。
- 課題2・4を解決：修正すべき範囲を判断しやすくする。
- 実装予定：なし（将来的にはシフトデータを外部DBに保存し、差分計算を実装）。
- 将来のDB案：Vercel Postgres または Supabase にシフト表と実績を保存し、サーバーコンポーネントでフェッチ。現状は Prisma (PostgreSQL) で代用。

## 機能No.5 CSVインポート/エクスポート (未実装)
- 勤怠データをCSVで一括インポート／エクスポートし、他システムとの連携を容易にする。
- 課題1・3を解決：記録漏れを外部から補填し、月末集計を簡略化。
- 実装予定：なし（本リポジトリでは CSV は未実装、Prisma DB を使用）。
- 将来のDB案：ファイルアップロード後に Supabase/Vercel Postgres のテーブルへ格納し、サーバー側でバリデーション。環境変数で接続先を管理（現状は Prisma/PostgreSQL）。

## 機能No.6 簡易ログイン/セルフ打刻
- 管理者/従業員のID・パスワードによる認証と、役割別のリダイレクト（管理者はダッシュボード、従業員はマイ打刻）。
- 従業員は当日の「出勤・休憩開始・休憩終了・退勤」を押せ、同日の打刻値（出勤/休憩開始/終了/退勤/メモ）をモーダルで修正可能。UIは直近14日を表示・編集、APIは日付制限なく追加/更新が可能。
- セッションは HMAC 署名付き Cookie で 1h TTL。`AUTH_SECRET` で署名。
- 本リポジトリで実装済み（`/login`, `/my`, `app/api/clock`）。
  - **ライブ時計**: 現在時刻を秒単位で表示するデジタル・アナログ時計を実装。
  - **入力バリデーション**: `HH:mm` 形式で厳密にチェック（49:59まで許容）。

## 機能No.7, 8 高度な認証機能 (未実装)
- メールによるパスワードリセットや、Authenticator アプリを用いた2要素認証 (2FA)。
- 小規模店舗での利用を想定しており、運用負荷を低く保つため、現状は実装予定なし。
- パスワード忘れ時は管理者がリセットを行う運用とする。

# ゴールインパクト
- オーナーが「今どのスタッフの勤怠に問題があるか」を把握できる。
- 月末の勤怠チェックにかかる時間を短縮し、売上向上やスタッフ育成に使える時間を増やす。
- 打刻漏れや過度な残業を早期に検知し、労務リスクと追加コストを低減する（修正依頼のやり取りを半減）。
